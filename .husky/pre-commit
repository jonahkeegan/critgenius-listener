#!/usr/bin/env sh

# Strict mode (portable subset)
set -e

echo "ğŸš¦ Pre-commit quality gate starting..."

echo "ğŸ”§ Running lint-staged (ESLint + Prettier on staged files)..."
if npx lint-staged; then
	echo "âœ… Lint & format passed"
else
	echo "âŒ Lint / format failed â€“ blocking commit"
	exit 1
fi

# Detect staged TypeScript source changes (added / copied / modified)
if git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' >/dev/null 2>&1; then
	echo "ğŸ§ª TypeScript changes detected â€“ running incremental type check..."
	# Capture start time; if unavailable mark unknown
	start_ts="$(date +%s 2>/dev/null || echo '')"
	# Use workspace aggregated script so each package runs its own type-check
	if pnpm -w type-check >/dev/null 2>&1; then
		end_ts="$(date +%s 2>/dev/null || echo '')"
		if [ -n "$start_ts" ] && [ -n "$end_ts" ]; then
			duration=$(( end_ts - start_ts ))
			if [ "$duration" -ge 0 ] && [ "$duration" -le 3600 ]; then
				echo "âœ… Type check passed (${duration}s)"
			else
				echo "âœ… Type check passed (duration unavailable)"
			fi
		else
			echo "âœ… Type check passed"
		fi
	else
		echo "âŒ Type check failed â€“ review errors above. Commit aborted." >&2
		exit 1
	fi
else
	echo "â© No staged TypeScript changes â€“ skipping type check"
fi

echo "ğŸ‰ All pre-commit checks passed"

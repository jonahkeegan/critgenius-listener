#!/usr/bin/env sh

# Strict mode (portable subset)
set -e

echo "ðŸš¦ Pre-commit quality gate starting..."

echo "ï¿½ï¸ Validating tooling versions against policy..."
if node scripts/validate-versions.mjs --pre-commit; then
	echo "âœ… Tool versions aligned"
else
	echo "âŒ Tool version validation failed â€“ see output above"
	exit 1
fi

echo "ï¿½ðŸ”§ Running lint-staged (ESLint + Prettier on staged files)..."
if npx lint-staged; then
	echo "âœ… Lint & format passed"
else
	echo "âŒ Lint / format failed â€“ blocking commit"
	exit 1
fi

echo "ðŸ“ Validating filenames for OneDrive/GitHub compatibility..."
if node scripts/filename-validator.mjs >/dev/null 2>&1; then
	echo "âœ… Filename validation passed"
else
	echo "âŒ Problematic filenames detected â€“ these will break OneDrive/GitHub sync:"
	echo "   Run 'pnpm validate:filenames' to see details and fix issues"
	echo "   Commit aborted to prevent sync issues"
	exit 1
fi

# Detect staged TypeScript source changes (added / copied / modified)
if git diff --cached --name-only --diff-filter=ACM | grep -E '\\.(ts|tsx)$' >/dev/null 2>&1; then
	echo "ðŸ§ª TypeScript changes detected â€“ running incremental type check..."
	# Capture start time; fallback to 0 if unsupported
	start_ts=$(date +%s 2>/dev/null || echo 0)
	if pnpm -w type-check >/dev/null 2>&1; then
		end_ts=$(date +%s 2>/dev/null || echo 0)
		duration=$(( end_ts - start_ts ))
		if [ "$duration" -ge 0 ] && [ "$duration" -le 3600 ]; then
			if [ "$duration" -gt 0 ]; then
				echo "âœ… Type check passed (${duration}s)"
			else
				echo "âœ… Type check passed (<1s)"
			fi
		else
			echo "âœ… Type check passed (duration unavailable)"
		fi
	else
		echo "âŒ Type check failed â€“ review errors above. Commit aborted." >&2
		exit 1
	fi
else
	echo "â© No staged TypeScript changes â€“ skipping type check"
fi

echo "ðŸŽ‰ All pre-commit checks passed"

# Optional: validate proxy drift when relevant files are staged
if git diff --cached --name-only | grep -E "^packages/shared/src/config/proxyRegistry\.ts$|^packages/client/vite\.config\.ts$|^scripts/generate-proxy-(env-example|docs)\.mjs$|^scripts/validate-proxy-drift\.mjs$" >/dev/null 2>&1; then
	echo "ðŸ” Validating proxy registry alignment..."
	if pnpm -w validate:proxy >/dev/null 2>&1; then
		echo "âœ… Proxy registry alignment OK"
	else
		echo "âŒ Proxy registry drift detected â€“ run: pnpm -w generate:proxy-docs && pnpm -w generate:proxy-env && pnpm -w validate:proxy" >&2
		exit 1
	fi
fi
